name: Update Profile README with Traffic

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Get profile traffic data
      id: profile_traffic
      run: |
        # Fetch total views and clones data for the profile from GitHub API
        PROFILE_VIEWS=$(curl -s -H "Authorization: token ${{ secrets.PAT_SECRET }}" https://api.github.com/users/hendzormati/views)
        PROFILE_CLONES=$(curl -s -H "Authorization: token ${{ secrets.PAT_SECRET }}" https://api.github.com/users/hendzormati/clones)

        # Debugging the raw response
        echo "PROFILE VIEWS Response: $PROFILE_VIEWS"
        echo "PROFILE CLONES Response: $PROFILE_CLONES"
        
        # Parse the counts from the API responses
        PROFILE_VIEWS_COUNT=$(echo $PROFILE_VIEWS | jq '.count')
        PROFILE_CLONES_COUNT=$(echo $PROFILE_CLONES | jq '.count')

        # Output the counts for later use in the workflow
        echo "Total Profile Views: $PROFILE_VIEWS_COUNT"
        echo "Total Profile Clones: $PROFILE_CLONES_COUNT"

        # Set the output for later use
        echo "profile_views_count=$PROFILE_VIEWS_COUNT" >> $GITHUB_ENV
        echo "profile_clones_count=$PROFILE_CLONES_COUNT" >> $GITHUB_ENV

    - name: Update README with profile traffic data
      run: |
        # Set Tunisia timezone
        export TZ="Africa/Tunis"
        
        # Read the existing README file
        README_CONTENT=$(cat README.md)
        
        # Replace placeholders with actual data
        UPDATED_README=$(echo "$README_CONTENT" | sed "s/ðŸ‘ï¸ Total Views of my Profile:.*/ðŸ‘ï¸ **Total Views** of my Profile: **${{ env.profile_views_count }}** views/")
        UPDATED_README=$(echo "$UPDATED_README" | sed "s/ðŸ”„ Total Clones of my Profile:.*/ðŸ”„ **Total Clones** of my Profile: **${{ env.profile_clones_count }}** clones/")
        
        # Format the last updated date
        UPDATED_README=$(echo "$UPDATED_README" | sed "s/Last traffic data update:.*/Last traffic data update: **$(date +"%a, %b %d, %Y %T %Z")**/")

        # Write the updated README back to the file
        echo "$UPDATED_README" > README.md

    - name: Commit and push changes
      uses: EndBug/add-and-commit@v7
      with:
        author_name: "GitHub Actions"
        author_email: "actions@github.com"
        message: "Update README with latest profile traffic"
